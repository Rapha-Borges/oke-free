# Criando um Cluster Kubernetes na OCI usando Terraform [#M√™sDoKubernetes](https://github.com/linuxtips/MesDoKubernetes)

### EM ATUALIZA√á√ÉO - VERIFIQUE A [ISSUE #8](https://github.com/Rapha-Borges/oke-free/issues/8) PARA MAIORES INFORMA√á√ïES

Crie uma conta gratuita na Oracle Cloud, e provisione um cluster Kubernetes usando o Terraform de forma simples e r√°pida.

## Oferta Especial [#M√™sDoKubernetes](https://github.com/linuxtips/MesDoKubernetes)

### Criando uma conta gratuita na Oracle Cloud

1. Todos ter√£o acesso a um tenant individual para execu√ß√£o do lab. Para ativar o ambiente, acesse este [link e crie a sua conta.](https://signup.cloud.oracle.com/)

IMPORTANTE:

- No cadastro o Pa√≠s/Territ√≥rio ser√° Brazil mas a Home Region do seu cadastro ser√° "US East-Ashburn‚Äù.
- Utilizem o mesmo e-mail que voc√™s usaram para se inscrever no evento, pois habilitamos uma oferta gratuita nesses e-mails. Caso j√° tenham uma conta OCI neste e-mail nos enviem um novo e-mail que habilitaremos outra oferta para voc√™s.
- No cadastro n√£o coloque o nome da empresa, pois ao colocar ser√° necess√°rio o CNPJ.
- Se voc√™ j√° tiver um trial (acesso a nuvem da Oracle) ativo nesse email, voc√™ ir√° conseguir realizar o lab pois ser√£o utilizados recursos always free, por√©m n√£o ter√° os 500 d√≥lares sem cart√£o pois um valor de testes j√° foi disponibilizado nos 30 dias¬†da¬†ativa√ß√£o.

### Vari√°veis do Terraform personalizadas para o lab

Caso queira realizar o lab com as configura√ß√µes utilizadas na live, basta substituir as vari√°veis do Terraform no arquivo `variables.tf` pelas vari√°veis abaixo. Mas lemre-se, as inst√¢ncias criadas com essas configura√ß√µes s√≥ ser√£o gratuitas enquanto os seus cr√©ditos oferecidos pela Oracle durante o #M√™sDoKubernetes estiverem ativos.

```
region = us-ashburn-1

shape = VM.Standard.A1.Flex

memory_in_gbs_per_node = 2

image_id = ocid1.image.oc1.iad.aaaaaaaao2zpwcb2osmbtliiuzlphc3y2fqaqmcpp5ttlcf573sidkabml7a

node_size = 1

kubernetes_version = v1.28.2
```

## Instalando o Terraform

### - Linux

```sh
wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update && sudo apt install terraform
```

### - Windows

1. Baixe o [Terraform](https://www.terraform.io/downloads.html) e descompacte o arquivo em um diret√≥rio de sua prefer√™ncia.

2. Adicione o diret√≥rio ao [PATH do Windows](https://www.java.com/pt-BR/download/help/path_pt-br.html).

## Baixando e configurando o OCI CLI

### - Linux

1. Execute o comando de instala√ß√£o:

```sh
bash -c "$(curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh)"
```

2. Quando solicitado para atualizar a vari√°vel PATH, digite `yes` e ele atualizar√° automaticamente seu arquivo .bashrc ou .bash_profile para voc√™. Se voc√™ usar um shell diferente, precisar√° informar o caminho para o OCI CLI (por exemplo, ~/zshrc).

3. Reinicie sua sess√£o no terminal.

4. Verifique a instala√ß√£o.

```sh
oci -v
```

### - Windows

1. Fa√ßa download do instalador MSI da CLI do OCI para Windows no GitHub [Releases](https://github.com/oracle/oci-cli/releases)

2. Execute o instalador e siga as instru√ß√µes.

## M√©todos de Autentica√ß√£o com a Nuvem OCI

Para este tutorial temos dois m√©todos de autentica√ß√£o:

- Baseado em Security Token
- Baseado em API Key

 > OBS √© muito importante escolher apenas uma das op√ß√µes de autentica√ß√£o.

## Configurando o OCI CLI (Baseado em Security Token)

1. Execute o comando de configura√ß√£o.

```sh
oci session authenticate --region us-ashburn-1
```

2. Exporte o token de autentica√ß√£o.

> Use a vari√°vel OCI_CLI_AUTH com o valor `security_token`

- Linux

```sh
export OCI_CLI_AUTH=security_token
```

- Windows

```sh
set OCI_CLI_AUTH=security_token
```

3. Verifique se a configura√ß√£o foi realizada com sucesso.

```sh
oci session validate --config-file ~/.oci/config --profile DEFAULT --auth security_token
```

## Configurando o OCI CLI (Baseado em API Key)

Voc√™ pode utilizar a autentica√ß√£o do tipo `API KEY` para criar e gerenciar o seu cluster. A vantage desse tipo de autentica√ß√£o √© que voc√™ n√£o precisa utilizar o `session token`.

1. Crie uma `API key`

- Entre no seu perfil, acesse a aba [API Keys](https://cloud.oracle.com/identity/domains/my-profile/api-keys) e clique em `Add API Key`.

2. Selecione `Generate API key pair`, fa√ßa o download da chave privada. Em seguida, clique em `Add`.

3. Ap√≥s o download, mova a chave para o diret√≥rio `~/.oci/` e renomeie para `oci_api_key.pem`.

```
mv ~/Downloads/<nome_do_arquivo>.pem ~/.oci/oci_api_key.pem
```

4. Corrija as permiss√µes da chave privada:

```
oci setup repair-file-permissions --file ~/.oci/oci_api_key.pem
```

5. Copie o texto que apareceu na p√°gina de cria√ß√£o da `API KEY` para o arquivo `~/.oci/config`. N√£o se esque√ßa de substituir o valor do compo `key_file` pelo caminho da chave privada `~/.oci/oci_api_key.pem`, conforme exemplo abaixo.

```
vim ~/.oci/config
```

> OBS O painel da OCI ao gerar os dados de acesso ela usa o perfil DEFAULT, recomendo criar o seu proprio perfil, ex: MINHA_API_KEY

N√£o recomendo usar o DEFAULT

```
[DEFAULT]
user=ocid1.user.oc1..xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
fingerprint=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
tenancy=ocid1.tenancy.oc1..xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
region=xxxxxxxx
key_file=~/.oci/oci_api_key.pem
```

> Criando um novo perfil ex: MINHA_API_KEY

```
[MINHA_API_KEY]
user=ocid1.user.oc1..xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
fingerprint=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
tenancy=ocid1.tenancy.oc1..xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
region=xxxxxxxx
key_file=~/.oci/oci_api_key.pem
```

> Use a vari√°vel OCI_CLI_AUTH com o valor `api_key`

- Linux

```sh
export OCI_CLI_AUTH=api_key
```

- Windows

```sh
set OCI_CLI_AUTH=api_key
```

6. Adicione os valores ao arquivo `export_variables.sh`, para exportar todas as vari√°veis necess√°rias para a autentica√ß√£o do terraform.

```
export TF_VAR_user_ocid=<your user ocid>
export TF_VAR_fingerprint=<your fingerprint>
export TF_VAR_tenancy_ocid=<your tenancy ocid>
export TF_VAR_private_key_path=~/.oci/oci_api_key.pem
export TF_VAR_ssh_private_key=$(cat id_rsa)
export TF_VAR_ssh_public_key=$(cat id_rsa.pub)
export TF_VAR_oci_profile=<DEFAULT ou MINHA_API_KEY>
```

Edite o arquivo `variables.tf` e remova o `#` das vari√°veis a seguir:

```
# variable "user_ocid" {
#   type    = string
# }

# variable "fingerprint" {
#   type    = string
# }

# variable "tenancy_ocid" {
#   type    = string
# }

# variable "private_key_path" {
#   type    = string
# }

# Deve ficar assim:

variable "user_ocid" {
  type    = string
}

variable "fingerprint" {
  type    = string
}

variable "tenancy_ocid" {
  type    = string
}

variable "private_key_path" {
  type    = string
}

```

Agora rode o script para exportar as vari√°veis:

```
source export_variables.sh
```

Agora rode o script para ver se deu certo a autentica√ß√£o baseado em API Key

```
oci iam region list --config-file ~/.oci/config --profile DEFAULT_API_KEY --auth api_key
```

> Se deu certo vai ter uma sa√≠da parecida com esse exemplo.

```
{
  "data": [
    {
      "key": "AMS",
      "name": "eu-amsterdam-1"
    },
    {
      "key": "ARN",
      "name": "eu-stockholm-1"
    },
    ...
  ]
}
```

> se apareceu uma lista de todas a regi√µes ent√£o deu certo, siga em frente.

## Instalando seu Kubectl | Kubernetes 1.28.2 |

### GNU/Linux

Kubectl √© quem faz a comunica√ß√£o com a API Kubernetes usando CLI. Devemos usar a mesma vers√£o que est√° explicita na vari√°veis do terraform. Veja [variables.tf](variables.tf)

1. Baixando o bin√°rio kubectl

```
curl -LO https://dl.k8s.io/release/v1.28.2/bin/linux/amd64/kubectl
```

2. Instalando o bin√°rio

```
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
```
3. Adicione kubectl completion bash

```
echo '
source <(kubectl completion bash)' >> ~/.bashrc
```  
4. Valide a vers√£o

```
kubectl version --client
```

- *Note: O comando acima ir√° gerar um aviso:*
    "WARNING: This version information is deprecated and will be replaced with the output from kubectl version --short."

**Voc√™ pode ignorar este aviso. Voc√™ est√° apenas verificando a vers√£o do kubectl que instalou.**

### Windows

1. Baixe o bin√°rio kubectl

```
curl.exe -LO "https://dl.k8s.io/release/v1.28.2/bin/windows/amd64/kubectl.exe"
```

2. **Anexe a pasta bin√°ria kubectl √† sua vari√°vel de ambiente PATH.**

3. Valide a vers√£o

```
kubectl version --client --output=yaml
```

**üîó [Guia de instala√ß√£o para todos os ambientes](https://kubernetes.io/docs/tasks/tools/)**

## Criando o cluster

1. Clone o reposit√≥rio.

```sh
git clone https://github.com/Rapha-Borges/oke-free.git
```

2. Dentro do diret√≥rio do projeto, gere a chave SSH e adicione o valor da chave p√∫blica na TF_VAR.

```sh
ssh-keygen -t rsa -b 4096 -f id_rsa
```

- Linux

```sh
export TF_VAR_ssh_public_key=$(cat id_rsa.pub)
```

- Windows

```
set /p TF_VAR_ssh_public_key=<id_rsa.pub
```

> OBS se o seu m√©todo de autentica√ß√£o escolhido  for baseado em Security Token

3. Valide o tempo de vida do token de autentica√ß√£o, aconselho que o tempo de vida seja maior que 30 minutos.

```sh
oci session validate --config-file ~/.oci/config --profile DEFAULT --auth security_token
```

Caso o token esteja pr√≥ximo de expirar, fa√ßa o refresh do token e exporte novamente.

```sh
oci session refresh --config-file ~/.oci/config --profile DEFAULT --auth security_token
```

```sh
export OCI_CLI_AUTH=security_token
```

4. Inicialize o Terraform.

```sh
terraform init
```

5. Crie o cluster.

```sh
terraform apply
```

- OBS: Opicionalmente, voc√™ pode utilizar o comando `terraform plan` para visualizar as altera√ß√µes que ser√£o realizadas antes de executar o `terraform apply`. Com os seguintes comandos:

```
terraform plan -out=oci.tfplan
terraform apply "oci.tfplan" -auto-approve
```

6. Acesse o cluster.

```sh
kubectl get nodes
```

### Script para cria√ß√£o do cluster

Caso queira automatizar o processo de cria√ß√£o do cluster, basta executar o script main.sh que est√° na raiz do projeto. O script ir√° gerar a chave SSH, adicionar a chave p√∫blica na TF_VAR, inicializar o Terraform e criar o cluster.

Aten√ß√£o: O script est√° em fase de testes e funciona apenas no Linux.

```sh
./main.sh
```

## Load Balancer

O cluster que criamos j√° conta com um Network Load Balancer configurado para expor uma aplica√ß√£o na porta 80. Basta configurar um servi√ßo do tipo `NodePort` com a porta `80` e a nodePort `30080`. Exemplos de como configurar o servi√ßo podem ser encontrados no diret√≥rio `manifests`.

O endere√ßo do Load Balancer √© informado na sa√≠da do Terraform, no formato `public_ip = "xxx.xxx.xxx.xxx"` e pode ser consultado a qualquer momento com o comando:

```sh
terraform output public_ip
```

## Deletando o cluster

1. Para deletar o cluster bastar executar o comando:

```sh
terraform destroy
```

## Problemas conhecidos

- ### Se voc√™ tentar criar um cluster com uma conta gratuita e receber o erro abaixo

```
Error: "Out of capacity" ou "Out of host capacity"
```

As contas gratuitas tem um n√∫mero limitado de inst√¢ncias dispon√≠veis, possivelmente a regi√£o que voc√™ est√° tentando criar o cluster n√£o tem mais inst√¢ncias dispon√≠veis. Voc√™ pode esperar at√© que novas inst√¢ncias fiquem dispon√≠veis ou tentar criar o cluster em outra regi√£o. Al√©m disso, o upgrade para uma conta `Pay As You Go` pode resolver o problema, pois as contas `Pay As You Go` tem um n√∫mero maior de inst√¢ncias dispon√≠veis. Voc√™ n√£o ser√° cobrado pelo uso de recursos gratuitos mesmo ap√≥s o upgrade.

- ### Erro `401-NotAuthenticated` ou o comando `kubectl` n√£o funciona. Isso ocorre porque o token de autentica√ß√£o expirou

Gere um novo token de autentica√ß√£o e exporte para a vari√°vel de ambiente `OCI_CLI_AUTH`.

```sh
oci session authenticate --region us-ashburn-1
```

- Linux

```sh
export OCI_CLI_AUTH=security_token
```

- Windows

```sh
set OCI_CLI_AUTH=security_token
```

- ### Erros devido a falha na execu√ß√£o do `terraform destroy`, impossibilitando a exclus√£o do cluster e todos os recuros. Ou erros como o `Error Code: CompartmentAlreadyExists` que n√£o s√£o resolvidos com o `terraform destroy`

Para resolver esse problema, basta deletar os recursos manualmente no console da OCI. Seguindo a ordem abaixo:

- [Kubernetes Cluster](https://cloud.oracle.com/containers/clusters)
- [Virtual Cloud Networks](https://cloud.oracle.com/networking/vcns)
- [Compartments](https://cloud.oracle.com/identity/compartments)

Obs: Caso n√£o apare√ßa o Cluster ou a VPN para deletar, certifique que selecionou o Compartment certo `k8s`.

> Siga o passo abaixo somente ap√≥s a cria√ß√£o do cluster com sucesso.

7. Edite o arquivo `~/.kube/config` seguindo o modelo abaixo:

```
- name: user-xxxxxxxxxx
  user:
    exec:
      apiVersion: client.authentication.k8s.io/v1beta1
      command: oci
      args:
      - ce
      - cluster
      - generate-token
      - --cluster-id
      - xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
      - --region
      - xxxxxxxxxxx
      - --auth            # ADICIONE ESSA LINHA
      - api_key           # ADICIONE ESSA LINHA
      - --profile         # ADICIONE ESSA LINHA
      - DEFAULT           # ADICIONE ESSA LINHA
```

# Refer√™ncias

- [Terraform Documentation](https://www.terraform.io/docs/index.html)
- [Terrafom Essentials](https://www.linuxtips.io/course/terraform-essentials)
- [Free Oracle Cloud Kubernetes cluster with Terraform](https://arnoldgalovics.com/oracle-cloud-kubernetes-terraform/)
